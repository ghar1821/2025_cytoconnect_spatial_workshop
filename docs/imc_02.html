<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Givanna Putri, Thomas O’neil" />


<title>IMC data analysis and visualisation</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/main/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">2025_cytoconnect_spatial_workshop</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="setup.html">Setup</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop">
    <span class="fab fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">IMC data analysis and visualisation</h1>
<h4 class="author">Givanna Putri, Thomas O’neil</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr <span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2025-11-26
</p>
<p>
<strong>Checks:</strong> <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong>
<code>2025_cytoconnect_spatial_workshop/</code> <span
class="glyphicon glyphicon-question-sign" aria-hidden="true"
title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="https://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/workflowr/workflowr">workflowr</a> (version
1.7.2). The <em>Checks</em> tab describes the reproducibility checks
that were applied when the results were created. The <em>Past
versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git
repository, you know the exact version of the code that produced these
results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the
global environment can affect the analysis in your R Markdown file in
unknown ways. For reproduciblity it’s best to always run the code in an
empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20251002code">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Seed:</strong>
<code>set.seed(20251002)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20251002code"
class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20251002)</code> was run prior to running
the code in the R Markdown file. Setting a seed ensures that any results
that rely on randomness, e.g. subsampling or permutations, are
reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Session information:</strong>
recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package
versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be
confident that you successfully produced the results during this
run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr
project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomghar18212025cytoconnectspatialworkshoptree799934a4412fce23dc5429b3e506d5c01b00dc56targetblank799934aa">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Repository version:</strong>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/tree/799934a4412fce23dc5429b3e506d5c01b00dc56" target="_blank">799934a</a>
</a>
</p>
</div>
<div
id="strongRepositoryversionstrongahrefhttpsgithubcomghar18212025cytoconnectspatialworkshoptree799934a4412fce23dc5429b3e506d5c01b00dc56targetblank799934aa"
class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development
and connecting the code version to the results is critical for
reproducibility.
</p>
<p>
The results in this page were generated with repository version
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/tree/799934a4412fce23dc5429b3e506d5c01b00dc56" target="_blank">799934a</a>.
See the <em>Past versions</em> tab to see a history of the changes made
to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for
the analysis have been committed to Git prior to generating the results
(you can use <code>wflow_publish</code> or
<code>wflow_git_commit</code>). workflowr only checks the R Markdown
file, but you know if there are other scripts or data files that it
depends on. Below is the status of the Git repository when the results
were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    data/.DS_Store
    Ignored:    data/imc/
    Ignored:    data/visium/

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not
included in this status report because it is ok for generated content to
have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">
<p>
These are the previous versions of the repository in which changes were
made to the R Markdown (<code>analysis/imc_02.Rmd</code>) and HTML
(<code>docs/imc_02.html</code>) files. If you’ve configured a remote Git
repository (see <code>?wflow_git_remote</code>), click on the hyperlinks
in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/799934a4412fce23dc5429b3e506d5c01b00dc56/analysis/imc_02.Rmd" target="_blank">799934a</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-26
</td>
<td>
wflow_publish("analysis/imc_02.Rmd")
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/ghar1821/2025_cytoconnect_spatial_workshop/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/imc_02.html" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/99c8f7bdc27b73f5780176e4d5b570a7cd080fbd/analysis/imc_02.Rmd" target="_blank">99c8f7b</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
<td>
wflow_publish(c("analysis/imc_02.Rmd", "analysis//index.Rmd"))
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/ghar1821/2025_cytoconnect_spatial_workshop/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/imc_02.html" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/0706e91de62463233b153f6de122e03ae3a3efce/analysis/imc_02.Rmd" target="_blank">0706e91</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
<td>
wflow_publish(c("analysis/imc_02.Rmd", "analysis/visium_01.Rmd",
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this part of IMC data analysis workshop, we will explore some
basic visualisation and analysis of IMC data using R.</p>
</div>
<div id="load-libraries" class="section level2">
<h2>Load libraries</h2>
<pre class="r"><code>library(ggplot2)
library(tidyverse)
library(here)
library(viridis)
library(uwot)
library(pheatmap)

# set default theme for ggplot
theme_set(theme_classic())</code></pre>
</div>
<div id="the-dataset" class="section level2">
<h2>The dataset</h2>
<p>The data used for this tutorial is from 35-marker IMC panel on FFPE
human intestines. The paper describing the data:
<code>https://doi.org/10.1002/cyto.a.24847</code>. The panel is designed
to delineate various immune cell subsets and HIV RNA.</p>
<p>The data can be downloaded either from the Google drive link in the
setup page or from <a
href="https://zenodo.org/records/10903826?token=eyJhbGciOiJIUzUxMiJ9.eyJpZCI6ImM5NTg0MjRkLTg0YjItNDYxMy1iMWY1LWQ3OTZjNjY4YTFhOCIsImRhdGEiOnt9LCJyYW5kb20iOiJmYTNkNDkyOWFkZGNkMjAwYWRkNGFiYzQzMjM5ZDE1ZCJ9.o_iqj5f3pjQCn7Z0-OKyYSB-DSGMWcI4EF1zzI-lISplpn9-mJzRr9Rz3x2MaFrTvadNn7K7PATLewxaphZ6RA">Zenodo</a>.</p>
</div>
<div id="loading-the-data" class="section level2">
<h2>Loading the data</h2>
<p>We will load the csv files containing single cell marker expression
segmented using Qupath and ImageJ in the previous analysis step.</p>
<pre class="r"><code>data &lt;- read.csv(
  file.path(here(), &quot;data&quot;, &quot;imc&quot;, &quot;measurements.csv&quot;)
)
head(data)</code></pre>
<pre><code>             Image                            Object.ID Object.type Name
1 all_channels.tif 49557086-eb05-45cd-a628-5d378bbc6a92  Annotation   NA
2 all_channels.tif 9f891fa0-7c59-41ab-a347-20ac13a6f78a  Annotation   NA
3 all_channels.tif 5f0b61a9-3de5-4d35-9deb-5e3edd67c5d7  Annotation   NA
4 all_channels.tif 750f6c24-170f-422a-afa9-e58511c81f15  Annotation   NA
5 all_channels.tif 90b3cccd-8d7d-46ce-8b52-d0983dd82146  Annotation   NA
6 all_channels.tif 7798a9a2-23f4-4302-867c-30b69d266db4  Annotation   NA
  Classification              Parent     ROI Centroid.X.px Centroid.Y.px
1          Other Root object (Image) Polygon         2.821         2.393
2          Other Root object (Image) Polygon        14.360         3.449
3          Other Root object (Image) Polygon        25.950         5.873
4          Other Root object (Image) Polygon        39.220         8.127
5          Other Root object (Image) Polygon       116.890         5.784
6          Other Root object (Image) Polygon       131.760         3.577
  Area.px.2 Perimeter.px ROI..1.00.px.per.pixel..aSMA.tif..Mean
1        28           22                                 0.2500
2        59           32                                 2.0508
3       166           66                                 1.4639
4       220           72                                 1.0545
5       250           78                                 0.3080
6        65           38                                 1.4154
  ROI..1.00.px.per.pixel..Axl.tif..Mean ROI..1.00.px.per.pixel..CCR6.tif..Mean
1                                0.1429                                 0.9643
2                                0.2203                                 1.1864
3                                0.3253                                 1.1145
4                                0.2909                                 1.6500
5                                0.2840                                 2.8080
6                                0.2923                                 2.2615
  ROI..1.00.px.per.pixel..CCR7.tif..Mean ROI..1.00.px.per.pixel..CD1c.tif..Mean
1                                 0.1071                                 0.0714
2                                 0.0339                                 0.1186
3                                 0.0181                                 0.0301
4                                 0.0545                                 0.0682
5                                 0.0560                                 0.1080
6                                 0.0769                                 0.0923
  ROI..1.00.px.per.pixel..CD3.tif..Mean ROI..1.00.px.per.pixel..CD4.tif..Mean
1                                0.1429                                0.0000
2                                0.3220                                0.1186
3                                1.0783                                0.6566
4                                0.2818                                0.2318
5                                0.2120                                0.1440
6                                0.7231                                0.3077
  ROI..1.00.px.per.pixel..CD8.tif..Mean ROI..1.00.px.per.pixel..CD11b.tif..Mean
1                                0.0357                                  0.1429
2                                0.0508                                  1.1864
3                                0.0482                                  0.4518
4                                0.2000                                  0.6091
5                                0.3120                                  0.5760
6                                0.0462                                  0.3385
  ROI..1.00.px.per.pixel..CD11c.tif..Mean
1                                  0.1071
2                                  0.3390
3                                  0.8193
4                                  0.8227
5                                  0.1880
6                                  1.0308
  ROI..1.00.px.per.pixel..CD14.tif..Mean ROI..1.00.px.per.pixel..CD20.tif..Mean
1                                 0.3571                                 0.1071
2                                 0.8814                                 0.2712
3                                 0.7892                                 0.1928
4                                 1.3045                                 0.1682
5                                 0.8960                                 0.1840
6                                 1.0769                                 2.2000
  ROI..1.00.px.per.pixel..CD31.tif..Mean ROI..1.00.px.per.pixel..CD38.tif..Mean
1                                 0.1429                                 0.0357
2                                 0.5424                                 0.1695
3                                 0.0602                                 0.1506
4                                 0.1864                                 0.1182
5                                 0.0560                                 0.0720
6                                 0.1077                                 0.1692
  ROI..1.00.px.per.pixel..CD45.tif..Mean
1                                 0.8214
2                                 1.4237
3                                 3.2952
4                                 2.5318
5                                 1.2640
6                                 2.3231
  ROI..1.00.px.per.pixel..CD45RA.tif..Mean
1                                   0.1429
2                                   0.1017
3                                   0.1024
4                                   0.1318
5                                   0.1400
6                                   2.1846
  ROI..1.00.px.per.pixel..CD45RO.tif..Mean
1                                   0.1429
2                                   1.1695
3                                   2.4759
4                                   0.4909
5                                   0.2440
6                                   1.2000
  ROI..1.00.px.per.pixel..CD69.tif..Mean
1                                 0.0000
2                                 0.1356
3                                 0.3072
4                                 0.1636
5                                 0.2400
6                                 0.2154
  ROI..1.00.px.per.pixel..CD163.tif..Mean
1                                  0.2857
2                                  0.5424
3                                  0.6988
4                                  0.6545
5                                  0.6600
6                                  0.7846
  ROI..1.00.px.per.pixel..CD303.tif..Mean
1                                  0.0000
2                                  0.1695
3                                  0.1145
4                                  0.0727
5                                  0.1000
6                                  0.0923
  ROI..1.00.px.per.pixel..CXCR3.tif..Mean
1                                  0.5000
2                                  0.5932
3                                  2.3373
4                                  1.2818
5                                  1.3400
6                                  1.7846
  ROI..1.00.px.per.pixel..CXCR5.tif..Mean
1                                  0.1071
2                                  0.0169
3                                  0.0723
4                                  0.1500
5                                  0.1480
6                                  0.2769
  ROI..1.00.px.per.pixel..DNA1.tif..Mean ROI..1.00.px.per.pixel..DNA2.tif..Mean
1                                45.7143                                81.5000
2                                28.8305                                47.7119
3                                33.8012                                58.4518
4                                35.1455                                60.2727
5                                28.8040                                48.4160
6                                24.3692                                37.3385
  ROI..1.00.px.per.pixel..Ecadherin.tif..Mean
1                                      0.1071
2                                      0.2034
3                                      0.3916
4                                      3.3591
5                                      5.8040
6                                      0.4923
  ROI..1.00.px.per.pixel..FOXP3.tif..Mean
1                                  0.4286
2                                  0.5932
3                                  0.5181
4                                  1.1818
5                                  1.7840
6                                  0.9538
  ROI..1.00.px.per.pixel..FXIIIa.tif..Mean
1                                   0.7500
2                                   0.3220
3                                   0.8614
4                                   0.7091
5                                   0.1720
6                                   0.5846
  ROI..1.00.px.per.pixel..HIV.tif..Mean ROI..1.00.px.per.pixel..HLADR.tif..Mean
1                                0.0714                                  0.0000
2                                0.0678                                  0.2542
3                                0.1205                                  0.7349
4                                0.1818                                  0.2500
5                                0.1200                                  0.0960
6                                0.1846                                  0.2308
  ROI..1.00.px.per.pixel..IL17.tif..Mean ROI..1.00.px.per.pixel..Ki67.tif..Mean
1                                 0.0000                                 0.0714
2                                 0.0508                                 0.1017
3                                 0.1084                                 0.0783
4                                 0.1273                                 0.3045
5                                 0.1800                                 0.2680
6                                 0.2154                                 0.1231
  ROI..1.00.px.per.pixel..La.tif..Mean
1                               0.4643
2                               0.2712
3                               0.2831
4                               0.2227
5                               0.1760
6                               0.2308
  ROI..1.00.px.per.pixel..Langerin.tif..Mean
1                                     0.9286
2                                     1.5254
3                                     1.4277
4                                     2.1500
5                                     2.5800
6                                     1.2308
  ROI..1.00.px.per.pixel..MPO.tif..Mean
1                                0.0000
2                                0.1695
3                                0.0783
4                                0.3682
5                                0.1320
6                                0.1385
  ROI..1.00.px.per.pixel..NaKATPase.tif..Mean
1                                      0.5000
2                                      1.4576
3                                      1.8916
4                                      9.3955
5                                     12.7960
6                                      1.8308
  ROI..1.00.px.per.pixel..Podoplanin.tif..Mean
1                                       0.2500
2                                       0.5424
3                                       1.5482
4                                       0.5136
5                                       0.1960
6                                       2.5231
  ROI..1.00.px.per.pixel..Siglec1.tif..Mean
1                                    0.0357
2                                    0.1695
3                                    0.1265
4                                    0.1182
5                                    0.1200
6                                    0.0923</code></pre>
<p>There are a lot of information in the data frames. We have columns
that describe:</p>
<ul>
<li>Centroid of the cells (<code>Centroid.X.px</code>,
<code>Centroid.Y.px</code>)</li>
<li>Area of the cells (<code>Area.px.2</code>)</li>
<li>Mean marker expression (from column 12 onwards)</li>
<li>Cell type label for the cell (<code>Classification</code>), if you
annotated some ROIs manually rather than just setting them all to
“Other”.</li>
</ul>
<p>The column names are not very user friendly, let’s clean them up.</p>
<pre class="r"><code>cnames &lt;- colnames(data)
# remove the rubbish prefixes
cnames &lt;- gsub(&quot;^ROI..1.00.px.per.pixel..&quot;, &quot;&quot;, cnames)
# remove the rubbish suffixes
cnames &lt;- gsub(&quot;.tif..Mean&quot; , &quot;&quot;, cnames)
colnames(data) &lt;- cnames</code></pre>
<p>Quick visualisation to check that data acquired properly. This is
just a scatter plot of cell centroids sized by cell surface area.</p>
<pre class="r"><code>ggplot(data, aes(Centroid.X.px, Centroid.Y.px, size=Area.px.2)) + 
  geom_point()</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-4-1">
Past versions of unnamed-chunk-4-1.png
</button>
</p>
<div id="fig-unnamed-chunk-4-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-4-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Quick visualisation of raw marker expression across all cells. The
code below will first convert the data to long format so we can plot all
markers in one go. Then we will plot the density of expression for each
marker.</p>
<pre class="r"><code># the markers start from column 12 to 48
# this just grabbed the column names for the markers
markers_cols &lt;- colnames(data)[12:48]

# convert the data to long format so we can plot all markers in one go
marker_exp_long &lt;- data %&gt;% 
  select(all_of(markers_cols), Object.ID) %&gt;%
  pivot_longer(
    cols = all_of(markers_cols),
    names_to = &quot;marker&quot;,
    values_to = &quot;raw_expression&quot;
  )

# plot the density of expression for each marker
ggplot(marker_exp_long, aes(x = raw_expression, color = marker, fill = marker)) +
  geom_density(show.legend = FALSE, alpha = 0.5) + 
  facet_wrap(~ marker, scales = &quot;free&quot;) +
  labs(
    title = &quot;Marker expression distributions&quot;,
    x = &quot;Raw marker expression&quot;,
    y = &quot;Density&quot;
  ) </code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-5-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-5-1">
Past versions of unnamed-chunk-5-1.png
</button>
</p>
<div id="fig-unnamed-chunk-5-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/figure/imc_02.Rmd/unnamed-chunk-5-1.png" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-5-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="data-normalisation-and-scaling" class="section level2">
<h2>Data normalisation and scaling</h2>
<p>We can either use arcsinh or log2 transformation (+1 in case we have
0 value as we can’t take log of 0) to normalise IMC data. Commonly, a
co-factor of 1 is used if you are using arcsinh transformation.</p>
<p>We will do both transformation and compare them using density
plots.</p>
<pre class="r"><code>marker_exp_longer &lt;- marker_exp_long %&gt;%
  mutate(
    log2_expression = log2(raw_expression + 1),
    arcsinh_expression = asinh(raw_expression / 1)
  ) %&gt;%
  pivot_longer(
    cols = c(log2_expression, arcsinh_expression, raw_expression),
    names_to = &quot;transformation&quot;,
    values_to = &quot;transformed_expression&quot;
  )

ggplot(marker_exp_longer, aes(x = transformed_expression, color = transformation, fill = transformation)) +
  geom_density(alpha = 0.3) + 
  facet_wrap(~ marker, scales = &quot;free&quot;) +
  labs(
    title = &quot;Comparing marker expression distributions after different transformations&quot;,
    x = &quot;Transformed marker expression&quot;,
    y = &quot;Density&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-6-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-6-1">
Past versions of unnamed-chunk-6-1.png
</button>
</p>
<div id="fig-unnamed-chunk-6-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/figure/imc_02.Rmd/unnamed-chunk-6-1.png" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-6-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Unlike flow cytometry data, most IMC signal intensities don’t reach
extremely large values. Many channels typically sit mostly between 0 and
tens, <em>sometimes</em> hundreds. In this range, arcsinh and log
transformations behave quite similarly, because arcsinh is approximately
linear for small values, and log is only mildly curving in this
range.</p>
<p>In some cases, however, the log transformation shifts the
distribution to the right while the arcsinh transformation appears to do
almost nothing. We see this in channels such as CXCR5, IL17, and Ki67 of
our example above. This occurs when marker expression is very low across
most cells. In this case, arcsinh still behaves linearly and therefore
has little effect on the distribution, whereas the log transformation
shifts values to the right due to the +1 offset added before taking the
logarithm to avoid log(0).</p>
<p>In some cases, e.g., Ecadherin or CD45, we see both transformations
exaggerating the bimodal distribution of the marker expression. This is
because both arcsinh and log transformations compress high values while
spreading out low values. Weakly separated subtypes which marker
expression appear <em>almost</em> unimodal will appear more clearly
bimodal after transformation. This is in keeping with what we do in flow
cytometry analysis, where we use arcsinh transformations to deliberately
expand the low end of the distribution (while compressing the top end)
to better separate dimly positive and negative populations.</p>
<p>For the remainder of this tutorial, we will use just arcsinh
transformation for normalisation.</p>
<pre class="r"><code>raw_exp &lt;- data %&gt;% select(all_of(markers_cols))
normed_scaled_exp &lt;- raw_exp %&gt;%
  mutate(across(all_of(markers_cols), ~ asinh(.x / 1))) %&gt;%  # arcsinh transformation
  # mutate(across(all_of(markers_cols), ~ log2(.x + 1))) %&gt;%  # log2 transformation
  mutate(Object.ID = data$Object.ID)

ggplot(normed_scaled_exp %&gt;%
         pivot_longer(
           cols = all_of(markers_cols),
           names_to = &quot;marker&quot;,
           values_to = &quot;normed_expression&quot;
         ), aes(x = normed_expression, color = marker, fill = marker)) +
  geom_density(show.legend = FALSE, alpha = 0.5) + 
  facet_wrap(~ marker, scales = &quot;free&quot;) +
  labs(
    title = &quot;Marker expression distributions after arcsinh transformation&quot;,
    x = &quot;Normalized marker expression&quot;,
    y = &quot;Density&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-7-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-7-1">
Past versions of unnamed-chunk-7-1.png
</button>
</p>
<div id="fig-unnamed-chunk-7-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/figure/imc_02.Rmd/unnamed-chunk-7-1.png" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-7-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We will also remove cells in the top 0.3% of expression values for
each marker as these are likely artefacts or aggregated antibodies.</p>
<pre class="r"><code># Remove cells where ANY marker has extreme high values (top 0.3%)
normed_exp_filtered &lt;- normed_scaled_exp

thresholds &lt;- lapply(markers_cols, function(marker) {
  quantile(normed_scaled_exp[[marker]], probs = 0.997)
})
names(thresholds) &lt;- markers_cols

# filter the data
for(marker in markers_cols) {
  normed_exp_filtered &lt;- normed_exp_filtered %&gt;% 
    filter(.data[[marker]] &lt;= thresholds[[marker]])
}

print(paste(&quot;Before filtering:&quot;, nrow(normed_scaled_exp), &quot;. After filtering:&quot;, nrow(normed_exp_filtered)))</code></pre>
<pre><code>[1] &quot;Before filtering: 559 . After filtering: 506&quot;</code></pre>
<p>Before proceeding, we will also scale the data to have mean of 0 and
standard deviation of 1 for each marker.</p>
<pre class="r"><code>normed_exp_filtered_scaled &lt;- normed_exp_filtered %&gt;%
  mutate(across(all_of(markers_cols), ~ scale(.x)))

# plot distribution after normalisation and scaling
normed_exp_filtered_scaled %&gt;%
  pivot_longer(
    cols = all_of(markers_cols),
    names_to = &quot;marker&quot;,
    values_to = &quot;normed_scaled_expression&quot;
  ) %&gt;%
  ggplot(aes(x = normed_scaled_expression, color = marker, fill = marker)) +
    geom_density(show.legend = FALSE, alpha = 0.5) + 
    facet_wrap(~ marker, scales = &quot;free&quot;) +
    labs(
      title = &quot;Marker expression distributions after arcsinh transformation and scaling&quot;,
      x = &quot;Normalized and scaled marker expression&quot;,
      y = &quot;Density&quot;
    )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-9-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-9-1">
Past versions of unnamed-chunk-9-1.png
</button>
</p>
<div id="fig-unnamed-chunk-9-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/figure/imc_02.Rmd/unnamed-chunk-9-1.png" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-9-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="dimensionality-reduction-and-clustering"
class="section level2">
<h2>Dimensionality reduction and clustering</h2>
<p>We can run UMAP and visualise the data in 2D space.</p>
<pre class="r"><code>set.seed(123)  # for reproducibility
cols_to_use &lt;- c(&quot;aSMA&quot;, &quot;CD14&quot;, &quot;CD11c&quot;, &quot;CD20&quot;, &quot;CD3&quot;, &quot;CD31&quot;, &quot;CD45&quot;, &quot;Ecadherin&quot;, &quot;FXIIIa&quot;, &quot;Ki67&quot;, &quot;Podoplanin&quot;)

# the as.matrix converts the data frame to a matrix which umap function requires
# as.data.frame() converts the output back to a data frame
# setNames() renames the columns of the data frame to UMAP1 and UMAP2
umap_res &lt;- umap(
  normed_exp_filtered_scaled %&gt;% select(all_of(cols_to_use)) %&gt;% as.matrix()
) %&gt;% as.data.frame() %&gt;% 
  setNames(c(&quot;UMAP1&quot;, &quot;UMAP2&quot;))</code></pre>
<p>Use ggplot to visualise the umap plot, coloured by Ecadherin
expression.</p>
<pre class="r"><code># add the Ecadherin expression to the umap results for plotting
umap_res$Ecadherin &lt;- normed_exp_filtered_scaled$Ecadherin

ggplot(umap_res, aes(x=UMAP1, y=UMAP2, color = Ecadherin)) +
  geom_point() +
  scale_color_viridis_c(option = &quot;D&quot;) +
  labs(
    title = &quot;UMAP coloured by Ecadherin expression&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-11-1">
Past versions of unnamed-chunk-11-1.png
</button>
</p>
<div id="fig-unnamed-chunk-11-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-11-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Run clustering using k-means and visualise is on UMAP plot.</p>
<pre class="r"><code>k &lt;- kmeans(normed_exp_filtered_scaled %&gt;% select(all_of(cols_to_use)), centers = 6)
umap_res &lt;- umap_res %&gt;%
  mutate(cluster = as.factor(k$cluster))

ggplot(umap_res, aes(x=UMAP1, y=UMAP2, color = cluster)) +
  geom_point() +  
  labs(
    title = &quot;UMAP coloured by k-means clusters&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-12-1">
Past versions of unnamed-chunk-12-1.png
</button>
</p>
<div id="fig-unnamed-chunk-12-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-12-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Inspect distribution of Ecadherin expression across clusters.</p>
<pre class="r"><code>normed_exp_filtered_scaled &lt;- normed_exp_filtered_scaled %&gt;%
  mutate(cluster = as.factor(k$cluster))

ggplot(normed_exp_filtered_scaled, aes(x=Ecadherin, color=cluster)) +
  geom_density() +
  labs(
    title = &quot;Ecadherin expression distribution across clusters&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-13-1">
Past versions of unnamed-chunk-13-1.png
</button>
</p>
<div id="fig-unnamed-chunk-13-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-13-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Draw heatmap of mean marker expression per cluster.</p>
<pre class="r"><code>normed_exp_filtered_scaled %&gt;%
  select(all_of(cols_to_use), cluster) %&gt;%
  group_by(cluster) %&gt;%
  summarise(across(all_of(cols_to_use), mean)) %&gt;%
  pivot_longer(cols = all_of(cols_to_use), names_to = &quot;marker&quot;, values_to = &quot;value&quot;) %&gt;%
  ggplot(aes(x=cluster, y=marker, fill=value)) + 
    geom_tile() + 
    scale_fill_viridis_c(option = &quot;D&quot;) +
    labs(
      title = &quot;Mean marker expression per cluster&quot;
    )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-14-1">
Past versions of unnamed-chunk-14-1.png
</button>
</p>
<div id="fig-unnamed-chunk-14-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-14-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Heatmap of marker expression for each cell annotated by cluster.</p>
<pre class="r"><code>pheatmap(
  normed_exp_filtered_scaled %&gt;%
    arrange(cluster, Object.ID) %&gt;%
    select(all_of(markers_cols), Object.ID) %&gt;%
    column_to_rownames(&quot;Object.ID&quot;) %&gt;%
    as.matrix(),
  cluster_rows = FALSE,
  cluster_cols = TRUE,
  annotation_row = normed_exp_filtered_scaled %&gt;%
    arrange(cluster, Object.ID) %&gt;%
    select(cluster, Object.ID) %&gt;%
    column_to_rownames(&quot;Object.ID&quot;),
  show_colnames = TRUE,
  show_rownames = FALSE,
  main = &quot;Heatmap of marker expression per cell annotated by cluster&quot;,
  color = inferno(100)
)</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-15-1">
Past versions of unnamed-chunk-15-1.png
</button>
</p>
<div id="fig-unnamed-chunk-15-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-15-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Spatial distribution of clusters.</p>
<pre class="r"><code># add the cell spatial information back to the scaled normalised data
normed_exp_filtered_scaled &lt;- normed_exp_filtered_scaled %&gt;% 
  mutate(
    X = data$Centroid.X.px[match(normed_exp_filtered_scaled$Object.ID, data$Object.ID)],
    Y = data$Centroid.Y.px[match(normed_exp_filtered_scaled$Object.ID, data$Object.ID)],
    Area = data$Area.px.2[match(normed_exp_filtered_scaled$Object.ID, data$Object.ID)]
  )
ggplot(normed_exp_filtered_scaled, aes(X, Y, size=Area, color = cluster)) +
  geom_point() +
  scale_color_viridis_d(option = &quot;H&quot;) +
  labs(
    title = &quot;Spatial distribution of clusters&quot;
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-16-1">
Past versions of unnamed-chunk-16-1.png
</button>
</p>
<div id="fig-unnamed-chunk-16-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-16-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Spatial distribution of marker expression (HIV). We use black
blackground to accentuate the marker expression.</p>
<pre class="r"><code>ggplot(normed_exp_filtered_scaled, aes(X, Y, size=Area, color = HIV)) +
  geom_point() +
  scale_color_viridis(option = &quot;inferno&quot;) +
  labs(
    title = &quot;Spatial distribution of HIV expression&quot;
  ) + 
  guides(size = guide_legend(override.aes = list(color = &quot;white&quot;))) +
  theme(
    plot.background = element_rect(fill = &quot;black&quot;),
    panel.background = element_rect(fill = &quot;black&quot;),
    axis.text = element_text(color = &quot;white&quot;),
    axis.title = element_text(color = &quot;white&quot;),
    axis.ticks = element_line(color = &quot;white&quot;),
    axis.line = element_line(color = &quot;white&quot;),
    title = element_text(color = &quot;white&quot;),
    legend.background = element_rect(fill = &quot;black&quot;),
    legend.text = element_text(color = &quot;white&quot;),
    legend.title = element_text(color = &quot;white&quot;),
    
  )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-17-1">
Past versions of unnamed-chunk-17-1.png
</button>
</p>
<div id="fig-unnamed-chunk-17-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-17-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>All markers spatial distribution faceted plot.</p>
<pre class="r"><code>normed_exp_filtered_scaled %&gt;% 
  pivot_longer(cols = all_of(markers_cols), names_to = &quot;marker&quot;, values_to = &quot;expression&quot;) %&gt;%
  ggplot(aes(X, Y, size=Area, color = expression)) +
    geom_point() +
    scale_color_viridis_c(option = &quot;inferno&quot;) +
    labs(
      title = &quot;Spatial distribution of marker expressions&quot;
    ) + 
    guides(size = guide_legend(override.aes = list(color = &quot;white&quot;))) +
    facet_wrap(~marker, ncol = 5) +
    theme(
      plot.background = element_rect(fill = &quot;black&quot;),
      panel.background = element_rect(fill = &quot;black&quot;),
      axis.text = element_text(color = &quot;white&quot;),
      axis.title = element_text(color = &quot;white&quot;),
      axis.ticks = element_line(color = &quot;white&quot;),
      axis.line = element_line(color = &quot;white&quot;),
      title = element_text(color = &quot;white&quot;),
      legend.background = element_rect(fill = &quot;black&quot;),
      legend.text = element_text(color = &quot;white&quot;),
      legend.title = element_text(color = &quot;white&quot;),
      strip.background = element_rect(fill = &quot;black&quot;, color = &quot;white&quot;),
      strip.text = element_text(color = &quot;white&quot;),
    )</code></pre>
<p><img src="figure/imc_02.Rmd/unnamed-chunk-18-1.png" width="1920" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-18-1">
Past versions of unnamed-chunk-18-1.png
</button>
</p>
<div id="fig-unnamed-chunk-18-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/2c126c8808a1edfe992c1519ce5d2a31e673a5b1/docs/figure/imc_02.Rmd/unnamed-chunk-18-1.png" target="_blank">2c126c8</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
<tr>
<td>
<a href="https://github.com/ghar1821/2025_cytoconnect_spatial_workshop/blob/7fbdd99f0027e9a7d1b3545738eb077144d17dd2/docs/figure/imc_02.Rmd/unnamed-chunk-18-1.png" target="_blank">7fbdd99</a>
</td>
<td>
Givanna Putri
</td>
<td>
2025-11-19
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.5

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Australia/Melbourne
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] pheatmap_1.0.13   uwot_0.2.3        Matrix_1.7-3      viridis_0.6.5    
 [5] viridisLite_0.4.2 here_1.0.2        lubridate_1.9.4   forcats_1.0.0    
 [9] stringr_1.5.2     dplyr_1.1.4       purrr_1.1.0       readr_2.1.5      
[13] tidyr_1.3.1       tibble_3.3.0      tidyverse_2.0.0   ggplot2_4.0.0    
[17] workflowr_1.7.2  

loaded via a namespace (and not attached):
 [1] sass_0.4.10        generics_0.1.4     lattice_0.22-7     stringi_1.8.7     
 [5] hms_1.1.3          digest_0.6.37      magrittr_2.0.4     timechange_0.3.0  
 [9] evaluate_1.0.5     grid_4.5.1         RColorBrewer_1.1-3 fastmap_1.2.0     
[13] rprojroot_2.1.1    jsonlite_2.0.0     processx_3.8.6     whisker_0.4.1     
[17] gridExtra_2.3      ps_1.9.1           promises_1.3.3     httr_1.4.7        
[21] scales_1.4.0       jquerylib_0.1.4    cli_3.6.5          rlang_1.1.6       
[25] withr_3.0.2        cachem_1.1.0       yaml_2.3.10        FNN_1.1.4.1       
[29] tools_4.5.1        tzdb_0.5.0         httpuv_1.6.16      vctrs_0.6.5       
[33] R6_2.6.1           lifecycle_1.0.4    git2r_0.36.2       fs_1.6.6          
[37] irlba_2.3.5.1      pkgconfig_2.0.3    callr_3.7.6        pillar_1.11.0     
[41] bslib_0.9.0        later_1.4.4        gtable_0.3.6       glue_1.8.0        
[45] Rcpp_1.1.0         xfun_0.53          tidyselect_1.2.1   rstudioapi_0.17.1 
[49] knitr_1.50         dichromat_2.0-0.1  farver_2.1.2       htmltools_0.5.8.1 
[53] labeling_0.4.3     rmarkdown_2.29     compiler_4.5.1     getPass_0.2-4     
[57] S7_0.2.0          </code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.5

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Australia/Melbourne
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] pheatmap_1.0.13   uwot_0.2.3        Matrix_1.7-3      viridis_0.6.5    
 [5] viridisLite_0.4.2 here_1.0.2        lubridate_1.9.4   forcats_1.0.0    
 [9] stringr_1.5.2     dplyr_1.1.4       purrr_1.1.0       readr_2.1.5      
[13] tidyr_1.3.1       tibble_3.3.0      tidyverse_2.0.0   ggplot2_4.0.0    
[17] workflowr_1.7.2  

loaded via a namespace (and not attached):
 [1] sass_0.4.10        generics_0.1.4     lattice_0.22-7     stringi_1.8.7     
 [5] hms_1.1.3          digest_0.6.37      magrittr_2.0.4     timechange_0.3.0  
 [9] evaluate_1.0.5     grid_4.5.1         RColorBrewer_1.1-3 fastmap_1.2.0     
[13] rprojroot_2.1.1    jsonlite_2.0.0     processx_3.8.6     whisker_0.4.1     
[17] gridExtra_2.3      ps_1.9.1           promises_1.3.3     httr_1.4.7        
[21] scales_1.4.0       jquerylib_0.1.4    cli_3.6.5          rlang_1.1.6       
[25] withr_3.0.2        cachem_1.1.0       yaml_2.3.10        FNN_1.1.4.1       
[29] tools_4.5.1        tzdb_0.5.0         httpuv_1.6.16      vctrs_0.6.5       
[33] R6_2.6.1           lifecycle_1.0.4    git2r_0.36.2       fs_1.6.6          
[37] irlba_2.3.5.1      pkgconfig_2.0.3    callr_3.7.6        pillar_1.11.0     
[41] bslib_0.9.0        later_1.4.4        gtable_0.3.6       glue_1.8.0        
[45] Rcpp_1.1.0         xfun_0.53          tidyselect_1.2.1   rstudioapi_0.17.1 
[49] knitr_1.50         dichromat_2.0-0.1  farver_2.1.2       htmltools_0.5.8.1 
[53] labeling_0.4.3     rmarkdown_2.29     compiler_4.5.1     getPass_0.2-4     
[57] S7_0.2.0          </code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
https://docs.mathjax.org/en/latest/web/configuration.html. This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
